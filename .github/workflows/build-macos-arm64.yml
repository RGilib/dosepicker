name: Build macOS arm64 app

on:
  workflow_dispatch:        # allow manual "Run workflow"
  push:
    tags: ["v*"]            # also build when you create a tag like v1.0.0

jobs:
  macos-arm64:
    # Apple Silicon runner (arm64). macos-14/15 map to Apple Silicon as of 2025.
    runs-on: macos-14

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11 (arm64)
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          architecture: "arm64"

      - name: Install build deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Build .app with PyInstaller
        run: |
          pyinstaller --windowed --name "FDACombo" \
            --icon a9qqs-dnvbm.icns \
            --collect-all pandas --collect-all openpyxl \
            main.py
          file "dist/FDACombo.app/Contents/MacOS/FDACombo"

      - name: Ad-hoc sign (no Apple ID needed)
        run: |
          codesign --deep --force --sign - "dist/FDACombo.app"

      - name: Zip the app for download
        run: |
          ditto -c -k --sequesterRsrc --keepParent \
            "dist/FDACombo.app" "FDACombo-mac-arm64.zip"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: FDACombo-mac-arm64
          path: FDACombo-mac-arm64.zip

